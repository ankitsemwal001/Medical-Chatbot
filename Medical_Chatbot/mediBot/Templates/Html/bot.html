<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/bot.css' %}">
    <title>Chat System</title>
</head>

<body>

<div class="chat-container">

    <div class="messages" id="chatBox">
        <!-- Messages will be loaded here dynamically -->
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Write something...">
        <button onclick="sendMessage()">Send</button>
    </div>

</div>

<script>
// Load messages repeatedly
function loadMessages() {
    fetch("/fetch/")
        .then(res => res.json())
        .then(data => {
            let chat = document.getElementById("chatBox");
            chat.innerHTML = "";

            data.messages.forEach(m => {
                let div = document.createElement("div");
                div.className = m.sender === "user" ? "msg right" : "msg left";
                div.innerHTML = `<p>${m.message}</p>`;
                chat.appendChild(div);
            });

            chat.scrollTop = chat.scrollHeight;
        });
}

setInterval(loadMessages, 1000); // auto refresh every 1 sec
loadMessages();

// Send user message
function sendMessage() {
    let text = document.getElementById("userInput").value;
    if (text.trim() === "") return;

    let formData = new FormData();
    formData.append("message", text);

    fetch("/send/", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("userInput").value = "";
        loadMessages();
    });
}

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = cookie.substring(name.length + 1);
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>